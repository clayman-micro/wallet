---

- name: Set project facts
  set_fact:
    project_root: "/home/{{ project_user }}/projects/{{ project_name }}"

- name: Create project folder
  file: path="{{ project_root }}" state=directory owner="{{ project_user }}" group="{{ project_user }}"
  remote_user: "{{ project_user }}"
  sudo: True

- name: Make project db user
  postgresql_user:
    name: "{{project_db_user}}"
    password: "{{project_db_password}}"
    role_attr_flags: CREATEDB,NOSUPERUSER
    login_host: 0.0.0.0
    login_user: docker
    login_password: docker

- name: Make project db
  postgresql_db:
    name: "{{ project_db_name }}"
    encoding: 'UTF-8'
    template: 'template1'
    owner: "{{ project_db_user }}"
    login_host: 0.0.0.0
    login_user: docker
    login_password: docker

- name: Assemble app config
  template: src="{{ item }}.tmpl" dest="{{ project_root }}/{{ item }}" owner="{{ project_user }}" group="{{ project_user }}"
  with_items:
    - "config.yml"
    - "supervisor.conf"
  remote_user: "{{ project_user }}"
  sudo: True

- include: deploy.yml

- name: Template nginx config
  template: src="nginx.conf.tmpl" dest="/etc/nginx/conf.d/{{ project_name }}.conf"
  remote_user: "{{ project_user }}"
  sudo: True
  notify: restart nginx

