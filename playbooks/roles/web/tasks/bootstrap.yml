---

- name: Set facts
  set_fact:
    project_root: "/home/{{ project_user }}/projects/web"

- name: Create nginx dirs
  file: path="{{ item }}" state=directory owner="{{ project_user }}" group="{{ project_user }}"
  with_items:
    - "/etc/nginx/conf.d"
    - "/etc/nginx/certs"
    - "/etc/nginx/certs/{{ project_name }}"
    - "/var/www/{{ project_name }}"
  sudo: True

- name: Create project web folder
  file: path="{{ item }}" state=directory owner="{{ project_user }}" group="{{ project_user }}"
  with_items:
    - "{{ project_root }}"
    - "/etc/nginx/certs/{{ project_name }}"
  remote_user: "{{ project_user }}"
  sudo: True

- name: Template project nginx config
  template: src="nginx.conf.tmpl" dest="/etc/nginx/conf.d/{{ project_name }}.conf" owner="{{ project_user }}" group="{{ project_user }}"
  remote_user: "{{ project_user }}"
  sudo: True

- name: Upload ssl certificate
  copy: src="{{ project_certs }}/{{ item }}" dest="/etc/nginx/certs/{{ project_name }}/{{ item }}" owner="{{ project_user }}" group="{{ project_user }}" mode="u=r,g=r,o=r"
  with_items:
    - "wallet.crt"
    - "wallet.key"
  remote_user: "{{ project_user }}"
  sudo: True

- name: Upload files
  copy: src="{{ item }}" dest="{{ project_root }}/{{ item }}" owner="{{ project_user }}" group="{{ project_user }}"
  with_items:
    - "nginx.conf"
    - "web.dockerfile"
  remote_user: "{{ project_user }}"
  sudo: True

- name: Build web image
  shell: docker build -t web -f web.dockerfile . chdir="{{ project_root }}"
  remote_user: "{{ project_user }}"
  sudo: True

- include: deploy.yml

- name: Check web container exists
  shell: docker ps -a --filter="name=web"
  register: output
  remote_user: "{{ project_user }}"
  sudo: True

- name: Remove existed web container
  shell: docker rm -f web
  when: output.stdout.find('web') != -1
  remote_user: "{{ project_user }}"
  sudo: True

- name: Create web container
  shell: docker create --name web --net=frontend -p 80:80 -p 443:443 -v /etc/nginx/conf.d/:/etc/nginx/conf.d -v /etc/nginx/certs/:/etc/nginx/certs -v /var/www/:/var/www --restart=always web
  remote_user: "{{ project_user }}"
  sudo: True

- name: Start web container
  shell: docker start web
  remote_user: "{{ project_user }}"
  sudo: True
